{% extends "base.html" %} {% block head %}
<style>
  .admin-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 32px 24px;
    max-width: 600px;
    margin: 40px auto;
  }
  .admin-card h1 {
    font-size: 2em;
    margin-bottom: 24px;
  }
  .admin-card h4 {
    margin-top: 24px;
  }

  /* New styles for the log display area */
  #scraper-logs {
    background-color: #212529; /* Dark background */
    color: #f8f9fa; /* Light text */
    border: 1px solid #495057;
    border-radius: 4px;
    padding: 12px;
    margin-top: 16px;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap; /* Allows text to wrap */
    word-wrap: break-word;
    font-family: 'Courier New', Courier, monospace; /* Monospaced font for logs */
    font-size: 0.875em;
    display: none; /* Hidden by default */
  }
</style>
{% endblock %} {% block content %}
<div class="admin-card">
  <h1 class="mb-4">Admin Dashboard</h1>
  <div class="list-group mb-4">
    <a
      href="/admin/download/researchers.csv"
      class="list-group-item list-group-item-action"
    >
      Download Master Spreadsheet
    </a>
    <a href="#" class="list-group-item list-group-item-action"
      >Update Database</a
    >
  </div>
  <div class="mb-4">
    <h4>Upload CSV</h4>
    <form>
      <input type="file" class="form-control mb-2" accept=".csv" />
      <button type="submit" class="btn btn-primary">Upload</button>
    </form>
  </div>
  <div>
    <h4>Create New User</h4>
    <form>
      <div class="mb-2">
        <input type="text" class="form-control" placeholder="Username" />
      </div>
      <div class="mb-2">
        <input type="email" class="form-control" placeholder="Email" />
      </div>
      <div class="mb-2">
        <input type="password" class="form-control" placeholder="Password" />
      </div>
      <button type="submit" class="btn btn-success">Create User</button>
    </form>
  </div>

  <!-- This is the section for running the scraper -->
  <div class="mt-4">
    <h4>Run Scraper</h4>
    <button id="run-scraper" class="btn btn-warning">Run Scraper</button>
    <div class="progress mt-2" style="display: none">
      <div
        id="scraper-progress"
        class="progress-bar"
        role="progressbar"
        style="width: 0%"
        aria-valuenow="0"
        aria-valuemin="0"
        aria-valuemax="100"
      >
        0%
      </div>
    </div>
    <small id="scraper-message" class="form-text text-muted mt-1"></small>
    <!-- This new <pre> element will display the logs -->
    <pre id="scraper-logs"></pre>
  </div>

  <div class="mt-4">
    <form action="/logout" method="post">
      <button type="submit" class="btn btn-danger">Logout</button>
    </form>
  </div>
</div>

<script>
  document.getElementById('run-scraper').addEventListener('click', function () {
    var button = this;
    var progressBar = document.getElementById('scraper-progress');
    var progressContainer = document.querySelector('.progress');
    var messageElement = document.getElementById('scraper-message');
    var logsElement = document.getElementById('scraper-logs');

    // --- Reset UI state on click ---
    button.disabled = true;
    button.textContent = 'Scraping...';
    messageElement.textContent = '';

    progressBar.classList.remove('bg-success', 'bg-danger');
    progressBar.classList.add('bg-primary');

    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    progressContainer.style.display = 'block';

    logsElement.style.display = 'block'; // Make the log area visible
    logsElement.textContent = 'Initializing scraper, waiting for logs...';

    // --- Start the scraper task ---
    fetch('/admin/run-scraper', { method: 'POST' })
      .then((response) => {
        if (!response.ok) {
          response.json().then((data) => {
            messageElement.textContent =
              data.message || 'Failed to start scraper.';
          });
          throw new Error('Failed to start scraper');
        }
        return response.json();
      })
      .then((data) => {
        messageElement.textContent = data.message;
        // --- Poll for progress and logs ---
        var interval = setInterval(function () {
          fetch('/admin/scraper-status')
            .then((response) => response.json())
            .then((data) => {
              var progress = data.progress;

              // Update the logs display
              if (data.logs && data.logs.length > 0) {
                logsElement.textContent = data.logs.join('\n');
                // Auto-scroll to the bottom to show the latest logs
                logsElement.scrollTop = logsElement.scrollHeight;
              }

              // Update progress bar and overall status
              if (progress < 0) {
                // Error state
                clearInterval(interval);
                progressBar.style.width = '100%';
                progressBar.textContent = 'Error!';
                progressBar.classList.remove('bg-primary', 'bg-success');
                progressBar.classList.add('bg-danger');
                button.disabled = false;
                button.textContent = 'Run Scraper Again';
                messageElement.textContent = data.message || 'Scraping failed.';
              } else if (progress >= 100) {
                // Completion state
                clearInterval(interval);
                progressBar.style.width = '100%';
                progressBar.textContent = 'Completed!';
                progressBar.classList.remove('bg-primary');
                progressBar.classList.add('bg-success');
                button.disabled = false;
                button.textContent = 'Run Scraper';
                messageElement.textContent = data.message;
              } else {
                // In-progress state
                progressBar.style.width = progress + '%';
                progressBar.textContent = progress + '%';
              }
            });
        }, 2000); // Poll every 2 seconds
      })
      .catch((error) => {
        console.error('Error:', error);
        button.disabled = false;
        button.textContent = 'Run Scraper';
        logsElement.textContent =
          'Failed to start the scraper task. Check the browser console for errors.';
      });
  });
</script>
{% endblock %}
