{% extends "base.html" %}

{% block content %}
<h1 style="text-align:center; margin-top:30px;">University Rankings</h1>

<!-- Map codes to display names -->
{% set uni_map = {
    "MU": "MONASH",
    "ANU": "ANU",
    "UA": "UA",
    "UM": "UM",
    "UNSW": "UNSW",
    "UQ": "UQ",
    "USYD": "USYD",
    "UWA": "UWA"
} %}

<div style="width:90%; max-width:900px; margin: 0 auto 24px auto; background:#fff; padding:18px 24px 10px 24px; border-radius:8px; box-shadow:0 2px 8px #ccc;">
    <form method="get" action="/universities" style="display:flex; align-items:center; gap:16px; flex-wrap:wrap; margin-bottom: 18px;">
        <label for="sort_by" style="font-weight:bold;">Rank by:</label>
        <select name="sort_by" id="sort_by" style="padding:6px 12px; font-size:1em; border-radius:4px; border:1px solid #bbb;">
            <option value="total_researchers" {% if request.query_params.get('sort_by', 'total_researchers') == "total_researchers" %}selected{% endif %}>Total number of researchers</option>
            <option value="total_articles" {% if request.query_params.get('sort_by', 'total_researchers') == "total_articles" %}selected{% endif %}>Total number of articles produced</option>
            <option value="abdc_a_star_a" {% if request.query_params.get('sort_by', 'total_researchers') == "abdc_a_star_a" %}selected{% endif %}>Total number of articles with A* or A rank journal</option>
            <option value="avg_jif" {% if request.query_params.get('sort_by', 'total_researchers') == "avg_jif" %}selected{% endif %}>Average JIF of all articles</option>
            <option value="avg_jif_5" {% if request.query_params.get('sort_by', 'total_researchers') == "avg_jif_5" %}selected{% endif %}>Average 5-year JIF of all articles</option>
            <option value="avg_articles" {% if request.query_params.get('sort_by', 'total_researchers') == "avg_articles" %}selected{% endif %}>Average number of articles per researcher</option>
        </select>
        <button type="submit" style="padding:7px 18px; background:#1976d2; color:#fff; border:none; border-radius:4px; font-size:1em; cursor:pointer;">Update</button>
    </form>
</div>

<table id="universities-table" style="margin: 30px auto; border-collapse: collapse; width: 95%; max-width: 1200px; background: #fff; box-shadow: 0 2px 8px #ccc;">
    <thead>
        <tr style="background: #1976d2; color: #fff; text-align: center;">
            <th style="padding: 12px 8px;" data-type="number">Rank <span class="arrow"></span></th>
            <th style="padding: 12px 8px;" data-type="text">University <span class="arrow"></span></th>
            <th style="padding: 12px 8px;" data-type="number">Total Researchers (Accounting) <span class="arrow"></span></th>
            <th style="padding: 12px 8px;" data-type="number">Total Researchers (Finance) <span class="arrow"></span></th>
            {% if sort_by == "total_articles" %}
                <th style="padding: 12px 8px;" data-type="number">No. of Articles (Accounting) <span class="arrow"></span></th>
                <th style="padding: 12px 8px;" data-type="number">No. of Articles (Finance) <span class="arrow"></span></th>
            {% elif sort_by == "abdc_a_star_a" %}
                <th style="padding: 12px 8px;" data-type="number">No. of A*/A Articles (Accounting) <span class="arrow"></span></th>
                <th style="padding: 12px 8px;" data-type="number">No. of A*/A Articles (Finance) <span class="arrow"></span></th>
            {% elif sort_by == "avg_jif" %}
                <th style="padding: 12px 8px;" data-type="number">Avg. JIF (Accounting) <span class="arrow"></span></th>
                <th style="padding: 12px 8px;" data-type="number">Avg. JIF (Finance) <span class="arrow"></span></th>
            {% elif sort_by == "avg_jif_5" %}
                <th style="padding: 12px 8px;" data-type="number">Avg. 5-Year JIF (Accounting) <span class="arrow"></span></th>
                <th style="padding: 12px 8px;" data-type="number">Avg. 5-Year JIF (Finance) <span class="arrow"></span></th>
            {% elif sort_by == "avg_articles" %}
                <th style="padding: 12px 8px;" data-type="number">Avg. Articles/Accounting Researcher <span class="arrow"></span></th>
                <th style="padding: 12px 8px;" data-type="number">Avg. Articles/Finance Researcher <span class="arrow"></span></th>
            {% endif %}   
            <th style="padding: 12px 8px;" data-type="number">{{ variable_label }} <span class="arrow"></span></th>
        </tr>
    </thead>
    <tbody>
        {% for university in universities %}
        <tr style="text-align:center; border-bottom: 1px solid #eee;">
            <td style="padding: 10px 6px;">{{ university.rank }}</td>
            <td style="padding: 10px 6px;">{{ uni_map.get(university.name, university.name) }}</td>
            <td style="padding: 10px 6px;">{{ university.accounting_count }}</td>
            <td style="padding: 10px 6px;">{{ university.finance_count }}</td>
            {% if sort_by == "total_articles" %}
                <td style="padding: 10px 6px;">{{ university.accounting_articles }}</td>
                <td style="padding: 10px 6px;">{{ university.finance_articles }}</td>
            {% elif sort_by == "abdc_a_star_a" %}
                <td style="padding: 10px 6px;">{{ university.accounting_a_star_a_articles }}</td>
                <td style="padding: 10px 6px;">{{ university.finance_a_star_a_articles }}</td>
            {% elif sort_by == "avg_jif" %}
                <td style="padding: 10px 6px;">{{ university.avg_jif_accounting }}</td>
                <td style="padding: 10px 6px;">{{ university.avg_jif_finance }}</td>
            {% elif sort_by == "avg_jif_5" %}
                <td style="padding: 10px 6px;">{{ university.avg_jif5_accounting }}</td>
                <td style="padding: 10px 6px;">{{ university.avg_jif5_finance }}</td>
            {% elif sort_by == "avg_articles" %}
                <td style="padding: 10px 6px;">{{ university.avg_articles_accounting }}</td>
                <td style="padding: 10px 6px;">{{ university.avg_articles_finance }}</td>
            {% endif %}
            <td style="padding: 10px 6px;">{{ university.variable_value }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    const table = document.getElementById('universities-table');
    const tbody = table.tBodies[0];
    const headers = table.tHead.rows[0].cells;
    const sortState = Array.from(headers).map(() => null);

    const rows = Array.from(tbody.querySelectorAll('tr'));

    function renderSortArrows(activeIdx) {
        Array.from(headers).forEach((th, i) => {
            const arrow = th.querySelector('.arrow');
            if (!arrow) return;
            if (i === activeIdx) {
                arrow.textContent = sortState[i] === 'asc' ? '▲' : '▼';
            } else {
                arrow.textContent = '';
            }
        });
    }

    const getCellText = (tr, idx) => (tr.children[idx]?.textContent || '').trim();

    const asNumber = (v) => {
        const cleaned = v.replace(/[, ]+/g, '');
        return parseFloat(cleaned);
    };

    const compareFactory = (idx, dir, type) => {
        const mul = dir === 'asc' ? 1 : -1;
        return (a, b) => {
            let va = getCellText(a, idx);
            let vb = getCellText(b, idx);
            if (type === 'number') {
                const na = asNumber(va);
                const nb = asNumber(vb);
                if (!Number.isNaN(na) && !Number.isNaN(nb)) {
                    return (na - nb) * mul;
                }
            }
            return va.localeCompare(vb, undefined, { numeric: true, sensitivity: 'base' }) * mul;
        };
    };

    Array.from(headers).forEach((th, idx) => {
        th.addEventListener('click', () => {
            sortState[idx] = sortState[idx] === 'asc' ? 'desc' : 'asc';
            sortState.forEach((_, i) => { if (i !== idx) sortState[i] = null; });

            const type = th.dataset.type || 'text';
            const dir = sortState[idx] || 'asc';

            rows.sort(compareFactory(idx, dir, type));
            rows.forEach(row => tbody.appendChild(row));
            renderSortArrows(idx);
        });
    });

    renderSortArrows(0);
</script>
{% endblock %}
