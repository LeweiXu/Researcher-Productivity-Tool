{% extends "base.html" %}
{% block content %}

<!-- Inline map so we can render full university names in the table -->
{% set uni_map = {
    "MU": "MONASH",
    "ANU": "ANU",
    "UA": "UA",
    "UM": "UoM",
    "UNSW": "UNSW",
    "UQ": "UQ",
    "USYD": "USYD",
    "UWA": "UWA"
} %}

<head>
    <title>{{ researcher.name }} - Researcher Profile</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; }
        .container { max-width: 1100px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #ccc; padding: 32px; }
        .header { display: flex; align-items: center; }
        .name { font-size: 2em; font-weight: bold; margin-right: 24px; }
        .uni-department a{ font-size: 1.0em; color: #949494; margin-top: 10px; }
        .uni-department a:hover { color: #0d47a1; text-decoration: underline; }
        .level { font-size: 1.2em; color: #555; margin-top: 10px; margin-bottom: 32px; }
        .section-title { font-size: 1.2em; font-weight: bold; margin: 32px 0 12px 0; }
        .pub-table { width: 100%; border-collapse: collapse; }
        .pub-table th, .pub-table td { border: 1px solid #bbb; padding: 10px 16px; text-align: left; }
        .pub-table th { background: #1976d2; color: #fff; cursor: pointer; user-select: none; }
        .pub-table a { color: #1976d2; text-decoration: underline; font-weight: 500; }
        .pub-table a:hover { color: #5b129b; text-decoration: underline; }
        .arrow { margin-left: 6px; font-size: 0.8em; opacity: 0.6; }
        #searchInput { margin: 10px 0; padding: 6px 8px; width: 240px; }
        a { color: #000000; text-decoration: none; }
        a:hover { color: #0d47a1; text-decoration: underline; }
        #pagination { margin-top: 18px; text-align: center; }
        #pagination button[disabled] { opacity: 0.5; cursor: not-allowed; }
        .controls { display: flex; gap: 12px; align-items: center; justify-content: space-between; margin: 12px 0; }
        .rows-select { display: flex; flex-direction: column; align-items: flex-end; }
        .rows-select label { margin-bottom: 5px; }
        select { padding: 6px 8px; }
        @media (max-width: 640px) {
            .rows-select { align-items: flex-start; }
        }
        #clearSortBtn {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 6px 14px;
            font-size: 0.9em;
            cursor: pointer;
            box-shadow: 0 2px 6px #ccc;
            transition: background 0.2s;
            margin-left: 8px;
        }
        #clearSortBtn:hover {
            background: #0d47a1;
        }
    </style>
</head>

<body>
<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="name"><a href="{{ researcher.profile_url }}">{{ researcher.name }}</a></div>
    </div>
    <div class="uni-department">
        <a href="{{ url_for('researchers')}}?university={{ researcher.university }}">{{ uni_map.get(researcher.university, researcher.university) }}</a>
        <a href="{{ url_for('researchers')}}?university={{ researcher.university }}&field={{ researcher.department }}">{{ researcher.department }}</a>
    </div>

    <!-- Human-readable academic level -->
    <div class="level">
        {% if researcher.level == "A" %}
            Associate Lecturer
        {% elif researcher.level == "B" %}
            Lecturer
        {% elif researcher.level == "C" %}
            Senior Lecturer
        {% elif researcher.level == "D" %}
            Associate Professor
        {% elif researcher.level == "E" %}
            Professor
        {% else %}
            {{ researcher.level }}
        {% endif %}
    </div>

    <!-- Controls -->
    <div class="controls">
        <input type="text" id="searchInput" placeholder="Search publications…">
        <div class="rows-select">
            <label for="rowsPerPage">Rows per page:</label>
            <select id="rowsPerPage" aria-label="Rows per page">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="all">All</option>
            </select>
        </div>
    </div>
    <div class="controls">
        <div style="font-size: 0.85em; color: #555; margin-bottom: 1px;">
            Note: <b>Shift+Click</b> column headers for secondary sorting etc.
        </div>
        <button id="clearSortBtn" style="display: flex; flex-direction: column; align-items: flex-end;">Clear Sorting</button>
    </div>

    <!-- Publications table -->
    <table class="pub-table" id="pub-table">
        <thead>
        <tr>
            <th data-type="text">Publications Title <span class="arrow"></span></th>
            <th data-type="text">Journal Name <span class="arrow"></span></th>
            <th data-type="number">Year <span class="arrow"></span></th>
            <th data-type="text">ABDC Ranking <span class="arrow"></span></th>
            <th data-type="number">No. of Authors <span class="arrow"></span></th>
        </tr>
        </thead>
        <tbody>
        {% for pub in publications %}
            <tr>
                <td>
                    {% if pub.publication_url %}
                        <a href="{{ pub.publication_url }}">{{ pub.title }}</a>
                    {% else %}
                        {{ pub.title }}
                    {% endif %}
                </td>
                <td>{{ pub.journal if pub.journal else "Working Paper"}}</td>
                <td>{{ pub.year }}</td>
                <td>{{ pub.ranking }}</td>
                <td>{{ pub.num_authors }}</td> <!-- Here might need to +1 if data scraped is number of co-authors -->
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    <div id="pagination">
        <button id="firstPage" disabled>First</button>
        <button id="prevPage" disabled>Previous</button>
        <span id="pageInfo"></span>
        <button id="nextPage" disabled>Next</button>
        <button id="lastPage" disabled>Last</button>
    </div>
</div>

<script>
    const table = document.getElementById('pub-table');
    const tbody = table.tBodies[0];
    const headers = table.tHead.rows[0].cells;

    const rows = Array.from(tbody.querySelectorAll('tr'));
    let rowsPerPage = 50;
    let currentPage = 1;
    let filteredRows = [...rows];

    function getRowsPerPage() {
        const val = document.getElementById('rowsPerPage').value;
        return val === 'all' ? filteredRows.length : parseInt(val, 10);
    }

    function showPage(page) {
        rowsPerPage = getRowsPerPage();
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;
        currentPage = Math.max(1, Math.min(page, totalPages));
        filteredRows.forEach((row, idx) => {
            row.style.display =
                (rowsPerPage === filteredRows.length) ||
                (idx >= (currentPage - 1) * rowsPerPage && idx < currentPage * rowsPerPage)
                    ? '' : 'none';
        });
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
        document.getElementById('firstPage').disabled = currentPage === 1;
        document.getElementById('lastPage').disabled = currentPage === totalPages || totalPages === 0;
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    }

    document.getElementById('firstPage').onclick = () => showPage(1);
    document.getElementById('lastPage').onclick = () => {
        const totalPages = Math.ceil(filteredRows.length / getRowsPerPage()) || 1;
        showPage(totalPages);
    };
    document.getElementById('prevPage').onclick = () => showPage(currentPage - 1);
    document.getElementById('nextPage').onclick = () => showPage(currentPage + 1);

    document.getElementById('rowsPerPage').addEventListener('change', function () {
        showPage(1);
    });

    document.getElementById('searchInput').addEventListener('input', function () {
        const q = this.value.toLowerCase();
        filteredRows = rows.filter(tr => tr.textContent.toLowerCase().includes(q));
        rows.forEach(tr => tr.style.display = 'none');
        showPage(1);
    });

    // Multi-column sorting
    const sortOrder = [];

    function renderSortArrows() {
        Array.from(headers).forEach((th, i) => {
            const arrow = th.querySelector('.arrow');
            const orderIdx = sortOrder.findIndex(s => s.idx === i);
            if (!arrow) return;
            if (orderIdx !== -1) {
                arrow.textContent = sortOrder[orderIdx].dir === 'asc' ? '▲' : '▼';
                arrow.style.opacity = 1;
                arrow.title = orderIdx === 0 ? 'Primary sort' : `Sort priority ${orderIdx+1}`;
            } else {
                arrow.textContent = '';
                arrow.style.opacity = 0.6;
                arrow.title = '';
            }
        });
    }

    function getCellText(tr, idx) {
        return (tr.children[idx]?.textContent || '').trim();
    }

    function asNumber(v) {
        const cleaned = v.replace(/[, ]+/g, '');
        return parseFloat(cleaned);
    }

    function multiCompare(a, b) {
        for (const {idx, dir} of sortOrder) {
            const th = headers[idx];
            const type = th.dataset.type || 'text';
            const va = getCellText(a, idx);
            const vb = getCellText(b, idx);
            let cmp;
            if (type === 'number') {
                const na = asNumber(va);
                const nb = asNumber(vb);
                cmp = (!Number.isNaN(na) && !Number.isNaN(nb)) ? na - nb : va.localeCompare(vb);
            } else {
                cmp = va.localeCompare(vb, undefined, { numeric: true, sensitivity: 'base' });
            }
            if (cmp !== 0) return dir === 'asc' ? cmp : -cmp;
        }
        return 0;
    }

    Array.from(headers).forEach((th, idx) => {
        th.addEventListener('click', (e) => {
            // Shift+click adds to sortOrder, normal click resets to single column
            const existing = sortOrder.find(s => s.idx === idx);
            if (e.shiftKey) {
                if (existing) {
                    existing.dir = existing.dir === 'asc' ? 'desc' : 'asc';
                } else {
                    sortOrder.push({idx, dir: 'asc'});
                }
            } else {
                sortOrder.length = 0;
                sortOrder.push({idx, dir: existing && existing.dir === 'asc' ? 'desc' : 'asc'});
            }
            filteredRows.sort(multiCompare);
            filteredRows.forEach(row => tbody.appendChild(row));
            renderSortArrows();
            showPage(1);
        });
    });

    // Clear button
    document.getElementById('clearSortBtn').onclick = () => {
        sortOrder.length = 0;
        renderSortArrows();
        filteredRows = [...rows];
        filteredRows.forEach(row => tbody.appendChild(row));
        showPage(1);
    };

    renderSortArrows();
    showPage(1);
</script>
</body>
{% endblock %}
